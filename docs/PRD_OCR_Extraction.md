# 門診表解析技術模組 (OCR & Data Extraction Pipeline)

> **相關聯主 PRD**：`PRD_planA.md` (4.1.4 門診表建檔管理)
> **狀態**：Draft / 討論中

## 1. 模組目標 (Module Goals)
本模組旨在解決「全台各大醫院門診表 PDF 格式零碎、非結構化」之痛點。系統需於後端或管理者輔助端，提供一套半自動解析流程，將人類可讀的格狀 PDF 轉換為系統可寫入至 `timetables` 資料庫的精確時段 (Timestamp)。

## 2. 挑戰與痛點 (Challenges)
各大醫院的門診表包含但不限於以下複雜情況：
1. **時間不統一**：各醫院的「上午診」定義不同（長庚可能 08:30 開始，台大可能 09:00 開始）。
2. **格式多樣**：有些是純文字 PDF，有些是掃描圖檔 PDF，且科別與醫師的對應關係（巢狀表格）難以用固定 Rule 解析。
3. **資訊雜訊**：包含醫師請假畫叉、代診括號、停診文字等非標準化標記。

## 3. 解析技術選型：混合式架構 (Hybrid Engine)
**決策**：為兼顧開發成本、API 費用與準確度，MVP 階段採用混合式引擎。

**工作串流 (Pipeline)**：
1. **L1 傳統提取 (Low Cost)**：使用開源套件 (如 `pdfjs` 或 `Tesseract`) 或低成本雲端 API 嘗試定錨表格結構與純文字內容。若是純電子檔 PDF，則直接萃取文字座標。
2. **L2 規則匹配 (Rule-based)**：後端套用常見的 Regex 規則，先過濾出標準化的「星期 vs 時段」陣列，並建立初步的對應關係。
3. **L3 LLM 補強 (AI Format)**：對於 L1/L2 無法自信判斷的畸零版塊（例如「請假」、「代診」的異常備註，或是排版過於特殊的單元格），將局部截圖或純文字送給輕量或中型 LLM (如 Gemini 1.5 Flash / GPT-4o mini) 要求梳理為 JSON。
4. **L4 人工防線 (Admin UI)**：若 L3 解析信心度低於門檻，直接將該區塊在後台標記為紅框，交由管理員使用 4.1 提到的「重新框選辨識」功能進行最終確認。

## 4. 管理者介面與資料儲存 (Admin UI & Database)
為配合高複雜度的原始資料，系統確定採用以下規格：

### 4.1 後台預覽與校正介面 (Admin Correction UI)
* **雙欄對照**：介面左側預覽原始 PDF 檔案，右側顯示系統解析出的輸入框（醫師、日期、具體時段）。
* **區域重新框選 (Re-OCR bounding box)**：若系統對某位醫師的時段解析錯誤，管理者不需手動 Key-in，而是提供「拉動框選範圍」的功能，重新對該特定區域發起辨識，以降低人工輸入成本。

### 4.2 資料庫最小顆粒度 (Database Granularity)
* **精確時間紀錄**：為確保寫入 Google Calendar 的行為精準，資料庫不採用粗略的「上午/下午/夜間」字串。
* **特定時段對應**：系統解析時需綁定各醫院的實際營業時間表。例如解析到「A醫院上午診」，寫入資料庫的時間應精確轉換為 `08:30:00 - 12:00:00`（依各醫院定義而異）。寫入行事曆時，則建立對應時間長度的精確事件。

### 4.3 純手動建檔介面 (Manual Data Entry UI)
當門診表格過於特殊、手寫稿、或是 OCR 完全失效時，管理員需具備純手動的高效建檔能力。

**介面與欄位設計 (UI & Fields)**：
1. **關聯設定區 (Context Setting)**：
   - 下拉選單/自動完成選項：選擇 `醫院 (Hospital)` ->連動-> `科別 (Department)` ->連動-> `醫師 (Doctor)`。
   - `生效日期 (Valid From)`：預設為今日或本月一號。
   - 輔助區：可選填上傳對照用的實體 PDF 或圖檔於左側作為參考（不經過 OCR）。
2. **週曆網格輸入區 (Weekly Grid Input)**：
   - 介面呈現如同一週行事曆視圖（週一至週日為橫軸，上午/下午/夜間為縱軸的大區塊）。
   - 管理員點擊對應格子（例如「週二」、「上午」區塊）即可新增該時段。
   - **精確填寫**：點擊格子後，跳出時間微調彈窗，自動代入該醫院上午診的預設 `Start Time` 與 `End Time`，並允許手動微調。
3. **高效操作機制**：
   - 提供「複製此時段到其他天」功能。
   - 提供「暫停門診 (休診/代診)」的特殊標記開關。
4. **發佈與寫入**：點擊儲存後，後端會將這些手動建立的網格資料，轉換為精確的時間戳，正式寫入 `timetables` 資料庫中，前台 PWA 即刻生效。
