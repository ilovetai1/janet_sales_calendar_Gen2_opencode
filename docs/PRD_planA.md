# 醫藥業務拜訪醫師門診資訊整合與週計畫系統 PRD

[To be written]

## 1. 產品背景與目標 (Product Background & Goals)
[To be written]

## 2. 目標受眾與使用情境 (Target Audience & Use Cases)
[To be written]

## 3. 系統架構與介面 (System Architecture & Interfaces)
[To be written]

## 4. 核心功能規格 (Core Features)
### 4.1 使用者端 (Front-end PWA)

#### 4.1.1 身份登入驗證 (Identity Login & Validation)
**目標**：確保業務員能快速登入系統，同時授權對其 Google 行事曆的完整讀寫權限，並支援首次登入的服務引導與後續的無縫 Token 刷新。

**規格細節**：
1. **登入方式與註冊**：
   - 僅支援 Google 帳號授權登入 (OAuth 2.0)，不開放一般 Email / Password 註冊。
   - **理由**：系統核心功能高度依賴自動新增與同步 Google Calendar 行程，強制使用 Google 帳號能確保服務體驗完整，減少不必要的設定斷點。
2. **退出與隱私功能**：
   - 提供「登出 (Sign Out)」功能，清除本地 Token。
   - 提供「刪除帳號 (Delete Account)」功能，呼叫後端 API 徹底清除資料庫使用者個人資料、相關行事曆綁定及關聯的紀錄，以符合 PWA 上架與隱私權規範。
3. **Google 授權範圍 (Scope)**：
   - 需要向 Google 請求 `https://www.googleapis.com/auth/calendar.events` (讀取與寫入特定日曆活動) 以及必要的 `email`、`profile` 權限。
   - 獲取寫入權限的目的是為了透過本系統，手動或自動為業務員在 Google Calendar 上建立未來一週的門診拜訪行程。
4. **授權狀態維護 (Refresh Token)**：
   - 前端需保存 Refresh Token 並於 Access Token 過期時進行背景自動刷新 (Silent Refresh)。
   - **異常處理**：若 Refresh Token 也失效 (例如 Google 端撤銷授權)，則強制將使用者登出並導向回登入頁，出現 Toast 提示「Google 授權已過期，請重新登入」。
5. **首次登入引導 (Onboarding)**：
   - 系統需判斷使用者是否為首次登入 (透過 DB flag 如 `is_onboarded` 判斷)。
   - 首次登入成功後，不直接進入主畫面，而是進入 3 頁式的 Onboarding 輪播引導頁 (介紹搜尋醫師、關注、排程功能簡介)，使用者點擊「開始使用」後才正式進入主畫面。

#### 4.1.2 訂閱狀態與權限管理 (Subscription & Permission)
**目標**：在統一採用 Google 登入的前提下，建立穩定且防弊的 SaaS 月租訂閱身分識別與升級機制。

**規格細節**：
1. **身分綁定 (Identity Binding)**：
   - 使用者在金流端（例如 Stripe, 藍新, 或綠界）的訂閱紀錄，將強制綁定其**登入時的 Google Email 地址**與系統生成的唯一 `user_id`。
   - 系統依據登入當下的 `user_id` 查詢 DB 中的 `subscription_status` (值：`free_trial`, `active`, `past_due`, `canceled`)。
2. **免費試用與權限管控設計**：
   - **試用期**：新帳號自動啟用 14 天 `free_trial`，期間開放全功能使用（含 Google Calendar 寫入）。
   - **過期或未訂閱狀態**：當 `subscription_status` 轉為非 `active` 時，系統自動實施 **功能降級 (Graceful Degradation)**：
     - 保留「讀取」權限：可查看已關注的醫師、過往的排程紀錄、私密筆記。
     - 鎖定「寫入/核心功能」：禁用「新增/修改排程」、「寫入 Google 行事曆」、「解鎖最新門診表」等功能。
     - 點擊被鎖定功能時，彈出「訂閱解鎖視窗」導向付款頁面。
3. **金流狀態同步 (Webhook)**：
   - 後端設置 Webhook 接收金流平台發送的狀態變更通知 (如扣款成功、取消訂閱)，並自動更新使用者 DB 中的 `subscription_status` 與 `current_period_end`。
   - 前端應用程式啟動或重整時，向後端發送一次輕量 API 檢查最新訂閱狀態，同步至客戶端 Global State。
4. **帳號異常與設備限制**：
   - 為了防範多人共用同一 Google 帳號與付費方案，系統需實作單一帳號的 Session 限制（例如最多允許 2 台裝置同時登入），超出限制時強制登出舊裝置。

#### 4.1.3 智慧尋醫與目標關注 (Targeting & Search)
**目標**：淘汰傳統紙本名片與筆記本，提供快速檢索專屬醫師的介面，並管理個人 Target 名單。

**規格細節**：
1. **搜尋引擎**：首頁提供搜尋列，支援輸入「醫院名稱」、「行政區」、「科別」或「醫師姓名」。
2. **醫師個人資訊頁 (Doctor Profile)**：點擊特定醫師後進入專屬頁面，呈現門診時段與過往看診資訊，並提供按鈕可將其加入/移除「我的關注」。
3. **Zero-Entry 筆記系統 (Smart Notes)**：
   - **自由文字方塊**：在醫師個人頁面中，提供單一的大範圍私密備忘錄（例如記錄「習慣喝 50 嵐無糖綠」），此筆記受資料庫 RLS 保護僅建立者本人可見。
   - **自動抓取拜訪軌跡**：系統透過後端比對 Google Calendar 行程，在醫師個人資訊頁上自動計算並顯示「上次拜訪日期」與「預計下次拜訪日期」，免除業務手動維護 CRM 欄位的負擔。
4. **離線快取 (Offline Access)**：進入「我的關注」清單與查看醫師個人頁面（含備忘錄）時，系統需支援離線存取，確保業務在醫院地下室診間等網路死角，仍可無縫查閱歷史筆記與目標名單。

#### 4.1.4 眾包式的門診表管理 (UGC PDF Upload & Incentive)
**目標**：透過業務隨手查核與上傳門診表來補足自動爬蟲的不足，並給予 SaaS 訂閱費折扣作為誘因，確保門診資料的即時性。

**規格細節**：
1. **混合上傳體驗 (Hybrid Workflow)**：使用者上傳門診表 (PDF/圖片/連結) 後，系統嘗試即時解析。若 10 秒內成功，立刻展示結果；若超過 10 秒未解出，則轉移至背景處理，並提示「處理中，完成後將通知您」，允許使用者先離開畫面。
2. **管理員後台退路 (Admin Fallback)**：當格式過於特殊系統徹底無法解析時，該任務將自動轉入系統後台 Pending 區，統一由「管理員/工程團隊」手動建檔處理。不強制開放前台讓使用者 Key-in，以確保資料結構一致性。
3. **貢獻獎勵與防弊機制 (Validation Mechanism)**：
   - **任務獎勵**：系統結算每月貢獻，當月上傳足夠數量（例如 N 份）的「有效門診表」，次月自動給予訂閱費折扣。
   - **防弊檢查**：「有效」的定義為「系統自動解析成功」或「管理員手動建檔核准」。若該份資料上線後，被其他業務點擊「報錯/檢舉」，且經管理員確認為惡意提供假檔案（如：餐廳菜單），系統將拔除該月之貢獻計算資格。
4. **版本資訊呈現**：門診表頁面僅需低調顯示「資料最後更新時間：YYYY-MM-DD」，不須掛名上傳者，保持去中心化。

#### 4.1.5 下週排程與 Google Calendar 雙向同步 (Smart Scheduling & Two-way Sync)
**目標**：作為業務的「單一工作站」，消弭門診表與行事曆之間的切換成本，並透過獨立日曆管理業務拜訪行程。

**規格細節**：
1. **獨立的專屬行事曆 (Dedicated Calendar)**：
   - 首次登入並獲得授權後，系統會透過 API 在使用者的 Google 帳號下自動建立一個特定的行事曆（例如命名為 `Janet Sales Calendar`）。
   - 往後所有透過本系統新增的行程，都會預設寫入此獨立日曆中，與使用者的主要/私人行事曆完全切分開來，保持畫面整潔。
2. **多方向觸發建立流程 (Multi-entry Scheduling)**：
   - **從醫師切入**：使用者可搜尋/選擇特定醫師，系統直接展開該醫師「下週可拜訪的門診時段」。使用者勾選時段後點擊「一鍵排程」，即自動生成對應時間與地點的行事曆事件。
   - **從日曆切入**：使用者在系統的「排程檢視」畫面點擊空白時段新增行程，系統提供下拉選單讓使用者「關聯特定醫師/醫院」，選擇後自動帶入門診表資訊。
3. **衝突偵測機制 (Soft Conflict Warning)**：
   - 系統在建立行程前，會呼叫 Google API 抓取使用者「所有開啟的行事曆」行程。
   - 只要「同一天」內的「同一個大時段（上午/下午/夜間）」出現了兩家「不同醫院」的行程，介面上會跳出「⚠️ 醫院跨區時段重疊警告」。
   - 警告僅作視覺提示，使用者仍可點擊「確認儲存」強行排入行程。
4. **即時雙向同步 (Real-time Two-way Sync)**：
   - 在本系統新增/刪除行程，同步更新至 Google Calendar；若在 Google Calendar 進行變更，本系統亦反映更新。

#### 4.1.6 每日門診異動總覽 (Daily Digest Notification)
**目標**：確保業務能掌握「關注醫師」的門診異動，同時避免被海量推播轟炸。
* **排程彙整與發送**：建立背景任務（Cron Job），每天早上彙整過去 24 小時內「關注名單」中醫師的門診表變動，發送一則推播總覽。
* **展示內容**：點擊通知後進入專屬頁面，列出「新增門診」、「取消/代診」或「超過 30 天未拜訪提醒」。

### 4.2 管理者端與進階功能 (Back-end Web & Future Roadmap)
- [Admin] **半自動門診表審核介面**：MVP 最核心的後台模組。設計用來讓工程/管理團隊上傳 PDF、預覽擷取文字，並手動核對寫入資料庫 (`timetables`)。
- [Backlog] **醫師群組分類與標籤系統**：允許業務自行用標籤（例如：重點攻堅、A級客戶、北投區）來分類與篩選醫師。
- [Backlog] **非 Google 系日曆支援**：未來評估接入 Apple Calendar (CalDAV) 或 Outlook 行事曆，MVP 階段僅專注確保 Google Calendar 雙向同步的穩定性。

## 5. 資料與整合邊界 (Data & Integration Boundaries)
- **前端資料輕量化 (Data Fetching)**：
  - 前端 PWA 絕不抓取或儲存原始的「門診表 PDF 檔案」或圖片，以節省頻寬與本地儲存空間。
  - 前端僅向後端 API 請求經過解析後的「醫師門診時間結構化 JSON 資料」，並以此繪製可點擊排程的 UI 呈現。
- **第三方 API 整合**：
  - **Google Calendar API**：PWA/後端需要擁有行事曆的讀寫權限以同步行程。
  - **Supabase Authentication**：作為唯一登入渠道。
- **資料庫權限 (RLS)**：
  - `private_notes` 與 `target_doctors` 表格強制綁定 Auth UID，確保資料絕對隔離。
  - `timetables` (門診表) 則開放全體驗證使用者查詢。

## 6. 非功能需求 (Non-Functional Requirements)
- **Mobile First**：UI/UX 介面設計以 iPhone 13 (Viewport 390x844) 尺寸與 Safari 瀏覽器為首要適配目標。
- **Offline Cache**：PWA 需支援本機 IndexedDB 快取，確保「離線時」依然能查閱個人關注清單、過往筆記與近一週的排程紀錄。
- **載入效能**：在 4G 網路下，醫師列表與日程表的首次載入時間不應超過 1.5 秒。
