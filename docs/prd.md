# 醫藥業務拜訪醫師門診資訊整合與週計畫系統 PRD

## 1. 產品背景與目標 (Product Background & Goals)
本產品旨在協助醫藥業務高效管理並整合分散於各大醫院的醫師門診表，透過 PWA 介面取代傳統紙本記事本，提供「目標（Target）醫師名單管理」、「門診異動追蹤」與「週計畫（Weekly Report）排程」等核心功能。

### MVP 核心產品決策：
1. **資料維護 (UGC 取代純爬蟲)**：因各大醫院門診表格式差異大防爬機制嚴格，放棄全面自動化爬蟲。改採「眾包模式 (User-Generated Content, UGC)」，允許付費業務自行上傳 PDF 門診表，系統輔助解析，結合眾人力量完善資料庫。
2. **排程衝突邏輯 (Soft Warning)**：醫藥業務拜訪時間變數高，系統防呆機制僅做到「時段重疊警告」（例如：同一天上午安排兩家不同醫院），不強制阻擋排程儲存。
3. **通知頻率 (Daily Digest)**：避免資訊疲勞，門診異動、醫師離職加入等通知，從「即時通知」改為「每日一次」的總覽推播。
4. **商業模式與權限 (All-Access MVP)**：產品定位為 B2C SaaS（向單一業務收費）。但在 MVP 階段，暫不區分免費與付費層級，所有註冊使用者皆享有完整功能，待產品上線獲得真實反饋後再引導付費牆。

## 2. 目標受眾與使用情境 (Target Audience & Use Cases)
- **目標受眾**：需要跑醫院拜訪醫生的醫藥業務。
- **主要情境**：
  - 每週一/週末：規劃下週拜訪行程，並寫入 Google Calendar。
  - 醫院現場：臨時被放鳥或醫師請假時，快速檢索該時段「同醫院/同行政區」可拜訪的替代醫師名單。
  - 睡前/出門前：確認當日「關注醫師」的門診異動總覽通知。

## 3. 系統架構與介面 (System Architecture & Interfaces)
- **前端 (PWA)**：以手機操作為主，提供接近原生的使用體驗與離線快取支援。
- **後端 (SaaS)**：使用 Supabase 提供核心登入驗證 (Google Auth) 與 Database (PostgreSQL)。
- **管理者端 (Web)**：以電腦操作為主，負責審核 UGC 任務、用戶名單與系統狀態監控。

## 4. 核心功能規格 (Core Features)

### 4.1 使用者端 MVP 核心 User Stories

#### 🎟️ Story 1: 基礎帳號與權限隔離 (Supabase Auth)
**作為一個醫藥業務**，我希望能夠使用 Google 帳號一鍵登入系統， **以便於**我能安全地保存我的關注名單與拜訪筆記，且不用擔心資料被其他業務同業看到。
* **[AC-1]** 使用者可透過 Google OAuth 授權登入 PWA。
* **[AC-2]** 資料庫配置 RLS (Row Level Security)，確保 User A 絕對無法透過 API 撈取 User B 的「關注名單」與「備忘錄」。
* **[AC-3]** 所有註冊的使用者在 MVP 階段皆預設擁有最高權限功能。

#### 🎟️ Story 1.5: 訂閱狀態與權限管理 (Subscription & Permission)
**作為一個系統營運者**，我希望能夠基於使用者的 Google 登入信箱綁定金流訂閱狀態，**以便於**實施 SaaS 服務的收費與功能解鎖。
* **[AC-1] 身分綁定金流**：使用者在金流端（例如 Stripe, 藍新）的付費狀態，強制綁定其登入的 Google Email 與系統唯一 `user_id`。
* **[AC-2] 免費試用與全域狀態**：新帳號自動給予 14 天免費試用。系統啟動時需輕量輪詢訂閱狀態 (`active`, `past_due`, `canceled`) 並存入全域狀態。
* **[AC-3] 功能降級 (Graceful Degradation)**：當使用者非處於付費活躍期時，系統不阻擋登入，但實施此降級措施：
  - 開放「讀取」權限：保留查看過往紀錄、既有關注醫師名單功能。
  - 鎖定「寫入/核心功能」：禁用「新增/修改排程」、「寫入 Google 行事曆」、「解鎖解析門診表」等按鈕，點擊時彈出付費解鎖引導。
* **[AC-4] 多裝置防弊**：限制單一帳號至多同時 2 台裝置登入，超出即強制登出舊連線。

#### 🎟️ Story 2: 眾包式的門診表管理 (UGC PDF Upload)
**作為一個醫藥業務**，我希望能夠隨手把自己去醫院拿到的門診表 (PDF 或連結) 上傳到系統， **以便於**我自己和其他業務都能查詢到最新的醫師看診時段。
* **[AC-1]** 系統提供「上傳門診表」入口，支援上傳 PDF 檔案或貼上該醫院門診表的 Web 連結。
* **[AC-2]** 後端接收到 PDF 後，能自動提取內文轉化為結構化的班表寫入資料庫。
* **[AC-3]** 若解析失敗，系統會將該筆上傳標記為 "Pending"，允許管理員（或系統擁有者）從後台進行手動確認或批次審核。
* **[AC-4]** 上傳成功的班表，會被標記「最後更新日期」與「提供者（可匿名）」。

#### 🎟️ Story 3: 智慧尋醫與目標關注 (Targeting & Search)
**作為一個醫藥業務**，我希望能夠透過行政區或關鍵字搜尋某科別的醫師，並將他們加入「我的關注」， **以便於**我能建立專屬於我的 Target 名單，淘汰紙本記事本。
* **[AC-1]** 首頁提供搜尋吧，支援輸入「醫院名稱」、「行政區」、「科別」或「醫師姓名」。
* **[AC-2]** 醫師列表旁會有按鈕，點擊即可加入/移除「我的關注」。
* **[AC-3]** 在「我的關注」分頁中，使用者可以針對特定醫師新增 Private Notes (例如：喜歡喝無糖綠茶、不喜歡被打擾的時段)，此筆記僅自己可見。

#### 🎟️ Story 4: 下週排程與 Google Calendar 雙向同步 (Smart Scheduling & Two-way Sync)
**作為一個醫藥業務**，我希望能在系統上一鍵將門診時段匯入行事曆，並與我的 Google Calendar 雙向同步，**以便於**我不再需要在門診表與行事曆 App 間來回切換。
* **[AC-1] 獨立專屬行事曆**：系統在首次授權後，會於使用者的 Google 帳號下建立一個專屬的日曆清單（例如 `Janet Sales Calendar`），所有本系統的拜訪行程預設寫入此獨立日曆，與使用者的私人主行事曆完全切分開來。
* **[AC-2] 多方向觸發排程**：
  - **從醫師切入**：檢視醫師門診表時，點擊特定可拜訪時段，一鍵匯入行事曆。
  - **從日曆切入**：在本系統行事曆點擊空白處新增行程時，提供一欄「連接到對應的醫師/醫院」，選定後自動帶入該醫師的門診與地點資訊。
* **[AC-3] 衝突警告 (Soft Conflict Warning)**：排程時若與使用者既有的 Google 行事曆全部行程發生時段重疊，系統僅跳出警告提示，最終仍交由業務自行決定是否強行儲存。
* **[AC-4] 即時雙向同步**：本系統與 Google Calendar App 針對該專屬日曆保持雙向同步；無論是在本系統排程，或是業務直接在 Google Calendar 修改時間/刪除，兩邊畫面都能反映出最新變更。

#### 🎟️ Story 5: 每日門診異動總覽 (Daily Digest Notification)
**作為一個醫藥業務**，我希望每天早上能收到一份關於我「關注醫師」的異動總整理， **以便於**我能掌握是否有休診、代診或換科的狀況，同時不會被海量的零碎通知轟炸。
* **[AC-1]** 建立背景任務（Cron Job），每天早上彙整過去 24 小時內，該使用者「關注名單」中醫師的門診表變動。
* **[AC-2]** 若有變動，發送一則推播通知或系統內信件：「今日異動總覽：您的關注名單有更新」。
* **[AC-3]** 點擊通知後可進入專屬頁面，列出：新增的門診、取消的門診、或是超過 30 天未拜訪的關注醫師提醒。

### 4.2 後台與進階功能擴充規範 (Future Roadmap)
- 管理者介面 (Admin Web App) 用於審核 UGC 門診表與 User 管理。
- 待第一階段上線後，接入 SaaS 訂閱模組（如 Stripe），將高頻查詢與提醒功能劃分至 Premium 付費計畫。

## 5. 資料與整合邊界 (Data & Integration Boundaries)
- **Google Calendar API**：PWA 需完整授權以達到讀寫雙向同步。
- **Supabase Authentication**：強制透過 Google OAuth 解決方案進行。
- **Supabase RLS (Row Level Security)**：Target 與 Note 表格強制綁定 Auth UID。

## 6. 非功能需求 (Non-Functional Requirements)
- **Mobile First**：UI/UX 設計以 iPhone 13 尺寸與 Safari 瀏覽器為首要適配目標。
- **Offline Cache**：PWA 需支援關注清單與最近一週行程的離線存取，以便醫院網路不佳時仍可查閱。
